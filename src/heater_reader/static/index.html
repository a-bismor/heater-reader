<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Boiler Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <h1>Boiler Monitor</h1>
    <canvas id="temps"></canvas>
    <section id="crop-setup">
      <h2>Crop Setup</h2>
      <button id="load-snapshot">Load Latest Snapshot</button>
      <button id="save-crop" disabled>Save Crop</button>
      <div style="position: relative; display: inline-block;">
        <img id="snapshot" alt="Latest snapshot" />
        <div
          id="crop-rect"
          style="position: absolute; border: 2px solid red; display: none;"
        ></div>
      </div>
    </section>
    <script>
      const snapshot = document.getElementById("snapshot");
      const cropRect = document.getElementById("crop-rect");
      const loadBtn = document.getElementById("load-snapshot");
      const saveBtn = document.getElementById("save-crop");
      let rect = null;
      let dragStart = null;

      async function loadData() {
        const response = await fetch("/api/readings");
        const data = await response.json();
        const labels = data.map((r) => r.captured_at);
        const boilerCurrent = data.map((r) => r.boiler_current);
        const boilerSet = data.map((r) => r.boiler_set);
        const radiatorCurrent = data.map((r) => r.radiator_current);
        const radiatorSet = data.map((r) => r.radiator_set);

        new Chart(document.getElementById("temps"), {
          type: "line",
          data: {
            labels,
            datasets: [
              { label: "Boiler Current", data: boilerCurrent },
              { label: "Boiler Set", data: boilerSet },
              { label: "Radiator Current", data: radiatorCurrent },
              { label: "Radiator Set", data: radiatorSet },
            ],
          },
        });
      }
      loadData();

      loadBtn.addEventListener("click", async () => {
        const resp = await fetch("/api/snapshot");
        if (!resp.ok) {
          return;
        }
        const blob = await resp.blob();
        snapshot.src = URL.createObjectURL(blob);
      });

      snapshot.addEventListener("mousedown", (event) => {
        if (!snapshot.src) return;
        const bounds = snapshot.getBoundingClientRect();
        dragStart = { x: event.clientX - bounds.left, y: event.clientY - bounds.top };
        rect = { x: dragStart.x, y: dragStart.y, w: 0, h: 0 };
        cropRect.style.display = "block";
        cropRect.style.left = `${rect.x}px`;
        cropRect.style.top = `${rect.y}px`;
        cropRect.style.width = "0px";
        cropRect.style.height = "0px";
        saveBtn.disabled = true;
      });

      snapshot.addEventListener("mousemove", (event) => {
        if (!dragStart) return;
        const bounds = snapshot.getBoundingClientRect();
        const x = event.clientX - bounds.left;
        const y = event.clientY - bounds.top;
        rect = {
          x: Math.min(dragStart.x, x),
          y: Math.min(dragStart.y, y),
          w: Math.abs(x - dragStart.x),
          h: Math.abs(y - dragStart.y),
        };
        cropRect.style.left = `${rect.x}px`;
        cropRect.style.top = `${rect.y}px`;
        cropRect.style.width = `${rect.w}px`;
        cropRect.style.height = `${rect.h}px`;
      });

      snapshot.addEventListener("mouseup", () => {
        if (!dragStart) return;
        dragStart = null;
        saveBtn.disabled = !(rect && rect.w > 0 && rect.h > 0);
      });

      saveBtn.addEventListener("click", async () => {
        if (!rect || !snapshot.naturalWidth || !snapshot.naturalHeight) return;
        const scaleX = snapshot.naturalWidth / snapshot.clientWidth;
        const scaleY = snapshot.naturalHeight / snapshot.clientHeight;
        const payload = {
          x: Math.round(rect.x * scaleX),
          y: Math.round(rect.y * scaleY),
          w: Math.round(rect.w * scaleX),
          h: Math.round(rect.h * scaleY),
        };
        await fetch("/api/crop", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      });
    </script>
  </body>
</html>
