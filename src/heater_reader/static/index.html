<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Boiler Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <h1>Boiler Monitor</h1>
    <div style="width: 100%; height: 50vh;">
      <canvas id="temps" style="width: 100%; height: 100%;"></canvas>
    </div>
    <div id="label-strip" style="display: grid; gap: 8px; margin: 8px 0;"></div>
    <table id="readings" style="display: none;"></table>
    <div id="reading-modal" style="display: none;">
      <div id="reading-modal-content">
        <button id="close-modal" type="button">Close</button>
        <div id="modal-error" style="color: #b00020;"></div>
        <img id="modal-image" alt="Reading image" />
        <div id="modal-captured"></div>
        <label>
          Boiler Current <input id="modal-boiler-current" type="number" />
        </label>
        <label>Boiler Set <input id="modal-boiler-set" type="number" /></label>
        <label>
          Radiator Current <input id="modal-radiator-current" type="number" />
        </label>
        <label>
          Radiator Set <input id="modal-radiator-set" type="number" />
        </label>
        <label>Mode <input id="modal-mode" type="text" /></label>
        <button id="save-modal" type="button">Save</button>
      </div>
    </div>
    <section id="crop-setup" data-crop-mode="click" style="text-align: center;">
      <h2>Crop Setup</h2>
      <button id="load-snapshot">Load Latest Snapshot</button>
      <button id="save-crop" disabled>Save Crop</button>
      <br />
      <span id="crop-message" style="color: #2a7a2a;"></span>
      <br />
      <br />
      <div style="position: relative; display: inline-block; max-width: 100%;">
        <img
          id="snapshot"
          alt="Latest snapshot"
          data-max-edge="640"
          src="https://fastly.picsum.photos/id/1084/536/354.jpg?grayscale&hmac=Ux7nzg19e1q35mlUVZjhCLxqkR30cC-CarVg-nlIf60"
          style="max-width: 100%; height: auto; display: block;"
        />
        <div
          id="crop-rect"
          style="position: absolute; border: 2px solid red; display: none; pointer-events: none; background-color: rgba(255, 0, 0, 0.2);"
        ></div>
      </div>
    </section>
    <script>
      const snapshot = document.getElementById("snapshot");
      const cropRect = document.getElementById("crop-rect");
      const loadBtn = document.getElementById("load-snapshot");
      const saveBtn = document.getElementById("save-crop");
      const readingsTable = document.getElementById("readings");
      const cropMessage = document.getElementById("crop-message");
      const labelStrip = document.getElementById("label-strip");
      const readingModal = document.getElementById("reading-modal");
      const closeModalBtn = document.getElementById("close-modal");
      const modalError = document.getElementById("modal-error");
      const modalImage = document.getElementById("modal-image");
      const modalCaptured = document.getElementById("modal-captured");
      const modalBoilerCurrent = document.getElementById("modal-boiler-current");
      const modalBoilerSet = document.getElementById("modal-boiler-set");
      const modalRadiatorCurrent = document.getElementById("modal-radiator-current");
      const modalRadiatorSet = document.getElementById("modal-radiator-set");
      const modalMode = document.getElementById("modal-mode");
      const saveModalBtn = document.getElementById("save-modal");
      let rect = null;
      let drawStart = null;
      let isDrawing = false;
      let readingsById = new Map();
      let activeReadingId = null;

      function formatLabel(timestamp) {
        const dt = new Date(timestamp);
        const dd = String(dt.getDate()).padStart(2, "0");
        const mm = String(dt.getMonth() + 1).padStart(2, "0");
        const hh = String(dt.getHours()).padStart(2, "0");
        const min = String(dt.getMinutes()).padStart(2, "0");
        return `${dd}-${mm}<br>${hh}:${min}`;
      }

      function renderLabels(readings) {
        labelStrip.innerHTML = "";
        if (!readings.length) {
          labelStrip.style.gridTemplateColumns = "1fr";
          return;
        }
        labelStrip.style.gridTemplateColumns = `repeat(${readings.length}, 1fr)`;
        for (const row of readings) {
          const label = document.createElement("button");
          label.type = "button";
          label.dataset.id = row.id;
          label.innerHTML = formatLabel(row.captured_at);
          labelStrip.appendChild(label);
        }
      }

      function openModal(reading) {
        activeReadingId = reading.id;
        modalError.textContent = "";
        modalCaptured.textContent = reading.captured_at;
        modalImage.src = reading.image_path || "";
        modalBoilerCurrent.value = reading.boiler_current ?? "";
        modalBoilerSet.value = reading.boiler_set ?? "";
        modalRadiatorCurrent.value = reading.radiator_current ?? "";
        modalRadiatorSet.value = reading.radiator_set ?? "";
        modalMode.value = reading.mode ?? "";
        readingModal.style.display = "block";
      }

      function closeModal() {
        readingModal.style.display = "none";
        activeReadingId = null;
      }

      async function saveModalEdits() {
        if (!activeReadingId) return;
        const payload = {
          boiler_current: modalBoilerCurrent.value === "" ? null : Number(modalBoilerCurrent.value),
          boiler_set: modalBoilerSet.value === "" ? null : Number(modalBoilerSet.value),
          radiator_current:
            modalRadiatorCurrent.value === "" ? null : Number(modalRadiatorCurrent.value),
          radiator_set: modalRadiatorSet.value === "" ? null : Number(modalRadiatorSet.value),
          mode: modalMode.value === "" ? null : modalMode.value,
          edited_by: "adam",
        };
        saveModalBtn.disabled = true;
        modalError.textContent = "";
        try {
          const resp = await fetch(`/api/readings/${activeReadingId}/edit`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) {
            modalError.textContent = "Failed to save reading.";
            return;
          }
          closeModal();
          await loadData();
          await loadTable();
        } finally {
          saveModalBtn.disabled = false;
        }
      }

      async function loadData() {
        const response = await fetch("/api/readings");
        const data = await response.json();
        readingsById = new Map(data.map((row) => [String(row.id), row]));
        const labels = data.map((r) => r.captured_at);
        const boilerCurrent = data.map((r) => r.boiler_current);
        const boilerSet = data.map((r) => r.boiler_set);
        const radiatorCurrent = data.map((r) => r.radiator_current);
        const radiatorSet = data.map((r) => r.radiator_set);

        new Chart(document.getElementById("temps"), {
          type: "line",
          data: {
            labels,
            datasets: [
              { label: "Boiler Current", data: boilerCurrent },
              { label: "Boiler Set", data: boilerSet },
              { label: "Radiator Current", data: radiatorCurrent },
              { label: "Radiator Set", data: radiatorSet },
            ],
          },
          options: {
            scales: {
              x: { ticks: { display: false } },
              y: { min: 10, max: 70 },
            },
          },
        });
        renderLabels(data);
      }
      loadData();

      async function loadTable() {
        const response = await fetch("/api/readings");
        const data = await response.json();
        if (data.length === 0) {
          readingsTable.style.display = "none";
          readingsTable.innerHTML = "";
          return;
        }
        readingsTable.style.display = "table";
        readingsTable.innerHTML =
          "<tr><th>Time</th><th>Boiler Current</th><th>Boiler Set</th><th>Radiator Current</th><th>Radiator Set</th><th>Mode</th></tr>";
        for (const row of data) {
          readingsTable.innerHTML += `<tr>
            <td>${row.captured_at}</td>
            <td contenteditable data-field="boiler_current" data-id="${row.id}">${row.boiler_current ?? ""}</td>
            <td contenteditable data-field="boiler_set" data-id="${row.id}">${row.boiler_set ?? ""}</td>
            <td contenteditable data-field="radiator_current" data-id="${row.id}">${row.radiator_current ?? ""}</td>
            <td contenteditable data-field="radiator_set" data-id="${row.id}">${row.radiator_set ?? ""}</td>
            <td contenteditable data-field="mode" data-id="${row.id}">${row.mode ?? ""}</td>
          </tr>`;
        }
      }

      document.addEventListener(
        "blur",
        async (event) => {
          if (!event.target.dataset.field) return;
          const field = event.target.dataset.field;
          const id = event.target.dataset.id;
          const value = event.target.textContent;

          await fetch(`/api/readings/${id}/edit`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ [field]: value, edited_by: "adam" }),
          });
        },
        true
      );

      loadTable();

      labelStrip.addEventListener("click", (event) => {
        const button = event.target.closest("button");
        if (!button) return;
        const reading = readingsById.get(button.dataset.id);
        if (!reading) return;
        openModal(reading);
      });

      closeModalBtn.addEventListener("click", () => {
        closeModal();
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeModal();
        }
      });

      saveModalBtn.addEventListener("click", async () => {
        await saveModalEdits();
      });

      function applySnapshotMaxEdge() {
        const maxEdge = Number(snapshot.dataset.maxEdge || "0");
        if (!maxEdge || !snapshot.naturalWidth || !snapshot.naturalHeight) {
          return;
        }
        if (snapshot.naturalWidth >= snapshot.naturalHeight) {
          snapshot.style.width = `${maxEdge}px`;
          snapshot.style.height = "auto";
        } else {
          snapshot.style.height = `${maxEdge}px`;
          snapshot.style.width = "auto";
        }
      }

      loadBtn.addEventListener("click", async () => {
        const resp = await fetch("/api/snapshot");
        if (!resp.ok) {
          return;
        }
        const blob = await resp.blob();
        snapshot.src = URL.createObjectURL(blob);
      });

      snapshot.addEventListener("load", () => {
        applySnapshotMaxEdge();
      });

      function snapshotPos(event) {
        const bounds = snapshot.getBoundingClientRect();
        return { x: event.clientX - bounds.left, y: event.clientY - bounds.top };
      }

      function updateRect(endPos) {
        rect = {
          x: Math.min(drawStart.x, endPos.x),
          y: Math.min(drawStart.y, endPos.y),
          w: Math.abs(endPos.x - drawStart.x),
          h: Math.abs(endPos.y - drawStart.y),
        };
        cropRect.style.left = `${rect.x}px`;
        cropRect.style.top = `${rect.y}px`;
        cropRect.style.width = `${rect.w}px`;
        cropRect.style.height = `${rect.h}px`;
      }

      snapshot.addEventListener("click", (event) => {
        if (!snapshot.src) return;
        const pos = snapshotPos(event);
        if (!isDrawing) {
          drawStart = pos;
          isDrawing = true;
          rect = { x: drawStart.x, y: drawStart.y, w: 0, h: 0 };
          cropRect.style.display = "block";
          cropRect.style.left = `${rect.x}px`;
          cropRect.style.top = `${rect.y}px`;
          cropRect.style.width = "0px";
          cropRect.style.height = "0px";
          saveBtn.disabled = true;
          return;
        }
        updateRect(pos);
        isDrawing = false;
        drawStart = null;
        saveBtn.disabled = !(rect && rect.w > 0 && rect.h > 0);
      });

      snapshot.addEventListener("mousemove", (event) => {
        if (!isDrawing) return;
        updateRect(snapshotPos(event));
      });

      function clearCropSelection() {
        rect = null;
        isDrawing = false;
        drawStart = null;
        cropRect.style.display = "none";
        saveBtn.disabled = true;
      }

      saveBtn.addEventListener("click", async () => {
        if (!rect || !snapshot.naturalWidth || !snapshot.naturalHeight) return;
        const scaleX = snapshot.naturalWidth / snapshot.clientWidth;
        const scaleY = snapshot.naturalHeight / snapshot.clientHeight;
        const payload = {
          x: Math.round(rect.x * scaleX),
          y: Math.round(rect.y * scaleY),
          w: Math.round(rect.w * scaleX),
          h: Math.round(rect.h * scaleY),
        };
        await fetch("/api/crop", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        cropMessage.textContent = "Crop saved.";
        clearCropSelection();
      });
    </script>
  </body>
</html>
